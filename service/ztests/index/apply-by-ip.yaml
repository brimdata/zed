script: |
  source service.sh
  zapi create -q test
  id=$(zapi load -use test@main in.zson | awk '{print $1}')
  zapi index create -q IPs type ip
  zapi index apply -use test@main IPs $id
  echo ===
  zapi query -Z -I query.zed

inputs:
  - name: service.sh
    source: ../service.sh
  - name: in.zson
    data: |
      {x:127.0.0.1}
      {x:127.0.0.2}
  - name: query.zed
    data: |
      from (
        :index_rules => sort id;
        test@main:indexes => sort rule.id | cut o:=this;
      )
      | left join on id = o.rule.id o
      | count(o) by name,type

outputs:
  - name: stderr
    data: ""
  - name: stdout
    regexp: |
      \w{27} committed
      ===
      \{
          name: "IPs",
          type: "ip",
          count: 1 \(uint64\)
      \}
